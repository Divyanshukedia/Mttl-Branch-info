<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Max Transtech Limited - PDF</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- PDFLib -->
  <script src="https://unpkg.com/pdf-lib@1.17.0/dist/pdf-lib.min.js"></script>
</head>
<body style="margin: 0; padding: 0;">

<iframe id="pdfViewer" style="width: 100vw; height: 100vh; border: none;"></iframe>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCKeLk5NX9bvBVhJfZhkZUATZQyrFNZDqU",
    authDomain: "branch-information-335f6.firebaseapp.com",
    projectId: "branch-information-335f6",
    storageBucket: "branch-information-335f6.firebasestorage.app",
    messagingSenderId: "1017170305224",
    appId: "1:1017170305224:web:d8d84468e8d61d71ea45fd",
    measurementId: "G-X6KYFQJ38Y"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const { jsPDF } = window.jspdf;

  async function generateMergedPdf() {
    const snapshot = await db.collection('entries').get();
    const entries = snapshot.docs.map(doc => doc.data());

    const mergedPdf = await PDFLib.PDFDocument.create();

    const pdf1Bytes = await fetch('./pdf1.pdf').then(res => res.arrayBuffer());
    const pdf1Doc = await PDFLib.PDFDocument.load(pdf1Bytes);
    const pdf1Pages = await mergedPdf.copyPages(pdf1Doc, pdf1Doc.getPageIndices());
    pdf1Pages.forEach(p => mergedPdf.addPage(p));

                const doc = new jsPDF({
                unit: 'mm',
                format: [216, 297], // width, height in mm (custom size)
            });

    const entriesByState = {};
    entries.forEach(entry => {
      if (!entriesByState[entry.state]) entriesByState[entry.state] = [];
      entriesByState[entry.state].push(entry);
    });

    let first = true;
    for (const state in entriesByState) {
      const rows = entriesByState[state].map(e => [e.station, e.address, e.name, e.contact, e.type]);
      if (!first) doc.addPage();
      first = false;

      doc.setFontSize(16);
      doc.setFillColor(255, 193, 7);
      doc.rect(10, 8, 190, 12, 'F');
      doc.setTextColor(0);
      doc.setFont("helvetica", "bold");
      doc.text(`${state.toUpperCase()}: BOOKING AND DELIVERY OFFICES`, 105, 16, { align: 'center' });

      doc.autoTable({
        startY: 30,
        head: [['STATION', 'ADDRESS', 'NAME', 'CONTACT NO', 'FACILITY TYPE']],
        body: rows,
        margin: { left: 10, right: 10 },
        styles: {
          fontSize: 8, cellPadding: 2, lineColor: [255, 193, 7], lineWidth: 0.3, halign: 'center'
        },
        headStyles: {
          fillColor: [30, 58, 138], textColor: [255, 255, 255], fontStyle: 'bold',
          lineColor: [255, 193, 7], lineWidth: 0.3, halign: 'center'
        },
        bodyStyles: {
          fillColor: [255, 255, 255], textColor: [0, 0, 0], lineColor: [255, 193, 7],
          lineWidth: 0.3, halign: 'center'
        }
      });
    }

    const tableBytes = doc.output('arraybuffer');
    const tableDoc = await PDFLib.PDFDocument.load(tableBytes);
    const tablePages = await mergedPdf.copyPages(tableDoc, tableDoc.getPageIndices());
    tablePages.forEach(p => mergedPdf.addPage(p));

    const pdf2Bytes = await fetch('./pdf2.pdf').then(res => res.arrayBuffer());
    const pdf2Doc = await PDFLib.PDFDocument.load(pdf2Bytes);
    const pdf2Pages = await mergedPdf.copyPages(pdf2Doc, pdf2Doc.getPageIndices());
    pdf2Pages.forEach(p => mergedPdf.addPage(p));

    return await mergedPdf.save();
  }

  // Render into iframe
  async function init() {
    const mergedPdfBytes = await generateMergedPdf();
    const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    document.getElementById('pdfViewer').src = url;
  }

  init();
</script>

</body>
</html>
