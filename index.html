<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Entry Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (compatibility layer) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <!-- SheetJS for Excel handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <!-- Heroicons CDN -->
    <script src="https://unpkg.com/@heroicons/vue@2.1.5/dist/outline.js"></script>
    <style>
        /* Custom styles for input focus and professional look */
        input:focus, select:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .dataTable thead th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        .dataTable tbody tr:hover {
            background-color: #f3f4f6;
        }
        .error {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .action-icons svg {
            width: 20px;
            height: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }
        /* DataTables custom styling */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 1rem;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div class="container mx-auto p-6 w-full max-w-7xl">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Data Entry Dashboard</h1>

        <!-- Form and Excel Upload Section -->
        <div class="bg-white p-8 rounded-xl shadow-lg mb-8 border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Add New Entry</h2>
            <form id="dataForm" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <input type="hidden" id="editDocId" name="editDocId">
                <div>
                    <label for="station" class="block text-sm font-medium text-gray-700">STATION</label>
                    <input type="text" id="station" name="station" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                    <p id="stationError" class="error hidden">Station already exists</p>
                </div>
                <div>
                    <label for="district" class="block text-sm font-medium text-gray-700">DISTRICT</label>
                    <input type="text" id="district" name="district" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                </div>
                <div>
                    <label for="state" class="block text-sm font-medium text-gray-700">STATE</label>
                    <input type="text" id="state" name="state" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                </div>
                <div class="lg:col-span-2">
                    <label for="address" class="block text-sm font-medium text-gray-700">ADDRESS</label>
                    <input type="text" id="address" name="address" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                </div>
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">NAME</label>
                    <input type="text" id="name" name="name" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                </div>
                <div>
                    <label for="contact" class="block text-sm font-medium text-gray-700">CONTACT NO</label>
                    <input type="tel" id="contact" name="contact" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">EMAIL ID</label>
                    <input type="email" id="email" name="email" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                </div>
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-700">TYPE</label>
                    <select id="type" name="type" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                        <option value="" disabled selected>Select Type</option>
                        <option value="Booking">Booking</option>
                        <option value="Delivery">Delivery</option>
                        <option value="Booking and Delivery">Booking and Delivery</option>
                    </select>
                </div>
                <div>
                    <label for="latitude" class="block text-sm font-medium text-gray-700">LATITUDE</label>
                    <input type="number" step="any" id="latitude" name="latitude" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                </div>
                <div>
                    <label for="longitude" class="block text-sm font-medium text-gray-700">LONGITUDE</label>
                    <input type="number" step="any" id="longitude" name="longitude" class="mt-1 block w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 transition duration-150">
                </div>
                <div class="lg:col-span-2">
                    <hr class="my-6 border-gray-200">
                    <p class="text-center text-sm font-medium text-gray-600 mb-4">OR</p>
                    <label for="excelUpload" class="block text-sm font-medium text-gray-700">Upload Excel File</label>
                    <input type="file" id="excelUpload" accept=".xlsx, .xls" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition duration-150">
                    <p id="uploadStatus" class="mt-2 text-sm text-gray-600"></p>
                </div>
                <div class="lg:col-span-2 flex justify-end">
                    <button type="submit" id="submitButton" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-150">Submit</button>
                </div>
            </form>
        </div>

        <!-- Data Table Section -->
        <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Existing Entries</h2>
                <button id="downloadExcel" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-150">Download as Excel</button>
            </div>
            <div class="overflow-x-auto">
                <table id="dataTable" class="min-w-full dataTable">
                    <thead>
                        <tr>
                            <th>STATION</th>
                            <th>DISTRICT</th>
                            <th>STATE</th>
                            <th>ADDRESS</th>
                            <th>NAME</th>
                            <th>CONTACT NO</th>
                            <th>EMAIL ID</th>
                            <th>TYPE</th>
                            <th>LATITUDE</th>
                            <th>LONGITUDE</th>
                            <th>ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKeLk5NX9bvBVhJfZhkZUATZQyrFNZDqU",
            authDomain: "branch-information-335f6.firebaseapp.com",
            projectId: "branch-information-335f6",
            storageBucket: "branch-information-335f6.firebasestorage.app",
            messagingSenderId: "1017170305224",
            appId: "1:1017170305224:web:d8d84468e8d61d71ea45fd",
            measurementId: "G-X6KYFQJ38Y"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Load existing data into table
        async function loadTableData() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const snapshot = await db.collection('entries').get();
            const data = [];
            snapshot.forEach(doc => {
                const entry = doc.data();
                const docId = doc.id;
                data.push({ ...entry, docId });
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">${entry.station}</td>
                    <td class="px-4 py-3">${entry.district}</td>
                    <td class="px-4 py-3">${entry.state}</td>
                    <td class="px-4 py-3">${entry.address}</td>
                    <td class="px-4 py-3">${entry.name}</td>
                    <td class="px-4 py-3">${entry.contact}</td>
                    <td class="px-4 py-3">${entry.email}</td>
                    <td class="px-4 py-3">${entry.type || 'N/A'}</td>
                    <td class="px-4 py-3">${entry.location.latitude}</td>
                    <td class="px-4 py-3">${entry.location.longitude}</td>
                    <td class="px-4 py-3 action-icons">
                        <span class="inline-block mr-3 text-blue-600 hover:text-blue-800" data-id="${docId}" data-action="edit">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </span>
                        <span class="inline-block text-red-600 hover:text-red-800" data-id="${docId}" data-action="delete">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Initialize DataTables
            if ($.fn.DataTable.isDataTable('#dataTable')) {
                $('#dataTable').DataTable().destroy();
            }
            $('#dataTable').DataTable({
                pageLength: 10,
                searching: true,
                ordering: true,
                lengthMenu: [5, 10, 25, 50],
                columnDefs: [
                    { orderable: false, targets: -1 } // Disable sorting on Action column
                ],
                language: {
                    search: "Search entries:",
                    lengthMenu: "Show _MENU_ entries"
                }
            });

            // Re-attach event listeners after DataTable initialization
            document.querySelectorAll('[data-action="edit"]').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.closest('[data-id]').dataset.id;
                    const doc = await db.collection('entries').doc(docId).get();
                    const data = doc.data();

                    // Populate form
                    document.getElementById('editDocId').value = docId;
                    document.getElementById('station').value = data.station;
                    document.getElementById('district').value = data.district;
                    document.getElementById('state').value = data.state;
                    document.getElementById('address').value = data.address;
                    document.getElementById('name').value = data.name;
                    document.getElementById('contact').value = data.contact;
                    document.getElementById('email').value = data.email;
                    document.getElementById('type').value = data.type;
                    document.getElementById('latitude').value = data.location.latitude;
                    document.getElementById('longitude').value = data.location.longitude;

                    // Change button to Update
                    const submitButton = document.getElementById('submitButton');
                    submitButton.textContent = 'Update';
                    submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
                });
            });

            document.querySelectorAll('[data-action="delete"]').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.closest('[data-id]').dataset.id;
                    if (confirm('Are you sure you want to delete this entry?')) {
                        try {
                            await db.collection('entries').doc(docId).delete();
                            await loadTableData();
                            alert('Entry deleted successfully!');
                        } catch (error) {
                            alert('Error deleting entry: ' + error.message);
                        }
                    }
                });
            });

            return data;
        }

        // Check if station is unique (case-insensitive), excluding current docId if editing
        async function isStationUnique(station, excludeDocId = null) {
            const snapshot = await db.collection('entries').get();
            return !snapshot.docs.some(doc => {
                if (excludeDocId && doc.id === excludeDocId) return false;
                return doc.data().station.toLowerCase() === station.toLowerCase();
            });
        }

        // Form and Excel submission
        document.getElementById('dataForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.textContent = 'Processing...';
            let errors = [];
            let successes = [];

            // Process form data if filled
            const editDocId = document.getElementById('editDocId').value;
            const station = document.getElementById('station').value;
            const district = document.getElementById('district').value;
            const state = document.getElementById('state').value;
            const address = document.getElementById('address').value;
            const name = document.getElementById('name').value;
            const contact = document.getElementById('contact').value;
            const email = document.getElementById('email').value;
            const type = document.getElementById('type').value;
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const stationError = document.getElementById('stationError');

            if (station && district && state && address && name && contact && email && type && latitude && longitude) {
                // Check station uniqueness
                if (!(await isStationUnique(station, editDocId))) {
                    stationError.classList.remove('hidden');
                    errors.push(`Form: Station "${station}" already exists`);
                } else {
                    stationError.classList.add('hidden');
                    const formData = {
                        station: station,
                        district: district,
                        state: state,
                        address: address,
                        name: name,
                        contact: contact,
                        email: email,
                        type: type,
                        location: {
                            latitude: parseFloat(latitude),
                            longitude: parseFloat(longitude)
                        },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    try {
                        if (editDocId) {
                            // Update existing entry
                            await db.collection('entries').doc(editDocId).set(formData, { merge: true });
                            successes.push('Form data updated successfully!');
                            document.getElementById('editDocId').value = '';
                            const submitButton = document.getElementById('submitButton');
                            submitButton.textContent = 'Submit';
                            submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                            submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        } else {
                            // Add new entry
                            await db.collection('entries').add(formData);
                            successes.push('Form data saved successfully!');
                        }
                        document.getElementById('dataForm').reset();
                    } catch (error) {
                        errors.push(`Form: Error saving data: ${error.message}`);
                    }
                }
            }

            // Process Excel file if selected
            const excelFile = document.getElementById('excelUpload').files[0];
            if (excelFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);

                        const validTypes = ['Booking', 'Delivery', 'Booking and Delivery', 'BOOKING', 'DELIVERY', 'BOOKING AND DELIVERY', 'BOOKING & DELIVERY'];
                        for (const row of json) {
                            // Parse LOCATION column (comma-separated lat,long)
                            let latitude = 0;
                            let longitude = 0;
                            const location = String(row.LOCATION || row.location || '');
                            if (location) {
                                const parts = location.split(',');
                                if (parts.length === 2) {
                                    latitude = parseFloat(parts[0].trim()) || 0;
                                    longitude = parseFloat(parts[1].trim()) || 0;
                                } else {
                                    errors.push(`Excel: Invalid LOCATION format in row: ${location}. Must be 'latitude,longitude'`);
                                    continue;
                                }
                            }

                            // Map Excel columns to form fields (case-insensitive)
                            const formData = {
                                station: row.STATION || row.station || '',
                                district: row.DISTRICT || row.district || '',
                                state: row.STATE || row.state || '',
                                address: row.ADDRESS || row.address || '',
                                name: row.NAME || row.name || '',
                                contact: row['CONTACT NO'] || row['contact no'] || row.CONTACT || row.contact || '',
                                email: row['EMAIL ID'] || row['email id'] || row.EMAIL || row.email || '',
                                type: row.TYPE || row.type || '',
                                location: {
                                    latitude: latitude,
                                    longitude: longitude
                                },
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            };

                            // Validate required fields
                            if (!formData.station || !formData.district || !formData.state || !formData.address || !formData.name || !formData.contact || !formData.type) {
                                errors.push(`Excel: Missing or invalid fields in row: ${JSON.stringify(row)}`);
                                continue;
                            }
                            if (!validTypes.includes(formData.type)) {
                                errors.push(`Excel: Invalid type in row: ${formData.type}. Must be one of: Booking, Delivery, Booking and Delivery, BOOKING, DELIVERY, BOOKING AND DELIVERY`);
                                continue;
                            }
                            // Skip duplicate stations silently
                            if (!(await isStationUnique(formData.station))) {
                                continue;
                            }

                            // Save to Firestore
                            try {
                                await db.collection('entries').add(formData);
                                successes.push(`Excel: Row for station "${formData.station}" saved successfully!`);
                            } catch (error) {
                                errors.push(`Excel: Error saving row for station "${formData.station}": ${error.message}`);
                            }
                        }

                        // Update status
                        if (errors.length > 0) {
                            uploadStatus.textContent = `Submission completed with errors:\n${errors.join('\n')}`;
                        } else if (successes.length > 0) {
                            uploadStatus.textContent = `Submission successful:\n${successes.join('\n')}`;
                        } else {
                            uploadStatus.textContent = 'No data submitted. Please fill the form or select an Excel file.';
                        }
                        await loadTableData();
                        document.getElementById('excelUpload').value = ''; // Reset file input
                    } catch (error) {
                        uploadStatus.textContent = `Excel: Error processing file: ${error.message}`;
                    }
                };
                reader.readAsArrayBuffer(excelFile);
            } else {
                // Update status if no Excel file but form processed
                if (errors.length > 0) {
                    uploadStatus.textContent = `Submission completed with errors:\n${errors.join('\n')}`;
                } else if (successes.length > 0) {
                    uploadStatus.textContent = `Submission successful:\n${successes.join('\n')}`;
                } else {
                    uploadStatus.textContent = 'No data submitted. Please fill the form or select an Excel file.';
                }
                await loadTableData();
            }
        });

        // Download table as Excel
        document.getElementById('downloadExcel').addEventListener('click', async function() {
            const data = await loadTableData();
            const worksheet = XLSX.utils.json_to_sheet(data.map(row => ({
                STATION: row.station,
                DISTRICT: row.district,
                STATE: row.state,
                ADDRESS: row.address,
                NAME: row.name,
                'CONTACT NO': row.contact,
                'EMAIL ID': row.email,
                TYPE: row.type || 'N/A',
                LOCATION: `${row.location.latitude},${row.location.longitude}`
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Entries');
            XLSX.writeFile(workbook, 'entries.xlsx');
        });

        // Initial table load
        loadTableData();
    </script>
</body>
</html>