<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Entry Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <!-- Heroicons (for edit/delete icons) -->
    <script src="https://unpkg.com/@heroicons/vue@2.1.5/dist/outline.js"></script>
    <style>
        /* Minimal custom CSS */
        .error {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .action-icons svg {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 fw-bold">Data Entry Dashboard</h1>
            <button id="addBranchButton" class="btn btn-primary">Add Branch</button>
        </div>

        <!-- Modal for Add/Edit Form -->
        <div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Add New Entry</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="dataForm">
                            <input type="hidden" id="editDocId" name="editDocId">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="station" class="form-label">STATION</label>
                                    <input type="text" id="station" name="station" class="form-control">
                                    <p id="stationError" class="error d-none">Station already exists</p>
                                </div>
                                <div class="col-md-6">
                                    <label for="district" class="form-label">DISTRICT</label>
                                    <input type="text" id="district" name="district" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="state" class="form-label">STATE</label>
                                    <input type="text" id="state" name="state" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="address" class="form-label">ADDRESS</label>
                                    <input type="text" id="address" name="address" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="name" class="form-label">NAME</label>
                                    <input type="text" id="name" name="name" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="contact" class="form-label">CONTACT NO</label>
                                    <input type="tel" id="contact" name="contact" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label">EMAIL ID</label>
                                    <input type="email" id="email" name="email" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="type" class="form-label">TYPE</label>
                                    <select id="type" name="type" class="form-select">
                                        <option value="" disabled selected>Select Type</option>
                                        <option value="Booking">Booking</option>
                                        <option value="Delivery">Delivery</option>
                                        <option value="Booking & Delivery">Booking & Delivery</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="latitude" class="form-label">LATITUDE</label>
                                    <input type="number" step="any" id="latitude" name="latitude" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="longitude" class="form-label">LONGITUDE</label>
                                    <input type="number" step="any" id="longitude" name="longitude" class="form-control">
                                </div>
                                <div class="col-12">
                                    <hr class="my-4">
                                    <p class="text-center text-muted mb-3">OR</p>
                                    <label for="excelUpload" class="form-label">Upload Excel File</label>
                                    <input type="file" id="excelUpload" accept=".xlsx, .xls" class="form-control">
                                    <p id="uploadStatus" class="mt-2 text-muted"></p>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" id="submitButton" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 fw-bold">Existing Entries</h2>
                    <button id="downloadExcel" class="btn btn-success">Download as Excel</button>
                </div>
                <table id="dataTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>STATION</th>
                            <th>DISTRICT</th>
                            <th>STATE</th>
                            <th>ADDRESS</th>
                            <th>NAME</th>
                            <th>CONTACT NO</th>
                            <th>EMAIL ID</th>
                            <th>TYPE</th>
<!--                             <th>LATITUDE</th>
                            <th>LONGITUDE</th> -->
                            <th>ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCNUR1sWFPtIurhQRIuujhhSboRoRJvulQ",
            authDomain: "mttl-brochure.firebaseapp.com",
            projectId: "mttl-brochure",
            storageBucket: "mttl-brochure.firebasestorage.app",
            messagingSenderId: "161005945772",
            appId: "1:161005945772:web:e0112b09967491658e3009",
            measurementId: "G-2692HWWKPW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Modal control
        const modal = new bootstrap.Modal(document.getElementById('dataModal'));
        const modalTitle = document.getElementById('modalTitle');
        const submitButton = document.getElementById('submitButton');

        function openModal(mode = 'add', data = null) {
            if (mode === 'edit' && data) {
                modalTitle.textContent = 'Edit Entry';
                document.getElementById('editDocId').value = data.docId;
                document.getElementById('station').value = data.station;
                document.getElementById('district').value = data.district;
                document.getElementById('state').value = data.state;
                document.getElementById('address').value = data.address;
                document.getElementById('name').value = data.name;
                document.getElementById('contact').value = data.contact;
                document.getElementById('email').value = data.email;
                document.getElementById('type').value = data.type;
                document.getElementById('latitude').value = data.location.latitude;
                document.getElementById('longitude').value = data.location.longitude;
                submitButton.textContent = 'Update';
                submitButton.classList.remove('btn-primary');
                submitButton.classList.add('btn-success');
            } else {
                modalTitle.textContent = 'Add New Entry';
                document.getElementById('dataForm').reset();
                document.getElementById('editDocId').value = '';
                submitButton.textContent = 'Submit';
                submitButton.classList.remove('btn-success');
                submitButton.classList.add('btn-primary');
                document.getElementById('stationError').classList.add('d-none');
            }
            modal.show();
        }

        function closeModal() {
            modal.hide();
            document.getElementById('dataForm').reset();
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('stationError').classList.add('d-none');
        }

        document.getElementById('addBranchButton').addEventListener('click', () => openModal('add'));

        // Load existing data into table
        async function loadTableData() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const snapshot = await db.collection('entries').get();
            const data = [];
            snapshot.forEach(doc => {
                const entry = doc.data();
                const docId = doc.id;
                data.push({ ...entry, docId });
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.station}</td>
                    <td>${entry.district}</td>
                    <td>${entry.state}</td>
                    <td>${entry.address}</td>
                    <td>${entry.name}</td>
                    <td>${entry.contact}</td>
                    <td>${entry.email}</td>
                    <td>${entry.type || 'N/A'}</td>
                    // <td>${entry.location.latitude}</td>
                    // <td>${entry.location.longitude}</td>
                    <td class="action-icons">
                        <span class="text-primary me-2" data-id="${docId}" data-action="edit">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </span>
                        <span class="text-danger" data-id="${docId}" data-action="delete">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Initialize DataTables
            if ($.fn.DataTable.isDataTable('#dataTable')) {
                $('#dataTable').DataTable().destroy();
            }
            $('#dataTable').DataTable({
                pageLength: 10,
                searching: true,
                ordering: true,
                lengthMenu: [5, 10, 25, 50],
                columnDefs: [
                    { orderable: false, targets: -1 }
                ],
                language: {
                    search: "Search entries:",
                    lengthMenu: "Show _MENU_ entries"
                }
            });

            // Re-attach event listeners
            document.querySelectorAll('[data-action="edit"]').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.closest('[data-id]').dataset.id;
                    const doc = await db.collection('entries').doc(docId).get();
                    const data = { ...doc.data(), docId };
                    openModal('edit', data);
                });
            });

            document.querySelectorAll('[data-action="delete"]').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.closest('[data-id]').dataset.id;
                    if (confirm('Are you sure you want to delete this entry?')) {
                        try {
                            await db.collection('entries').doc(docId).delete();
                            await loadTableData();
                            alert('Entry deleted successfully!');
                        } catch (error) {
                            alert('Error deleting entry: ' + error.message);
                        }
                    }
                });
            });

            return data;
        }

        // Check if station exists and get its docId
        async function getStationDocId(station) {
            if (!station) return null;
            const snapshot = await db.collection('entries').get();
            for (const doc of snapshot.docs) {
                if (doc.data().station.toLowerCase() === station.toLowerCase()) {
                    return doc.id;
                }
            }
            return null;
        }

        // Delete all entries in Firestore
        async function deleteAllEntries() {
            const snapshot = await db.collection('entries').get();
            const batch = db.batch();
            snapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        }

        // Form and Excel submission
        document.getElementById('dataForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.textContent = 'Processing...';
            let errors = [];
            let successes = [];
            let formSubmitted = false;

            // Process form data
            const editDocId = document.getElementById('editDocId').value;
            const station = document.getElementById('station').value.trim();
            const district = document.getElementById('district').value.trim();
            const state = document.getElementById('state').value.trim();
            const address = document.getElementById('address').value.trim();
            const name = document.getElementById('name').value.trim();
            const contact = document.getElementById('contact').value.trim();
            const email = document.getElementById('email').value.trim();
            const type = document.getElementById('type').value;
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const stationError = document.getElementById('stationError');

            if (station && district && state) {
                const existingDocId = await getStationDocId(station);
                if (existingDocId && existingDocId !== editDocId) {
                    stationError.classList.remove('d-none');
                    errors.push(`Form: Station "${station}" already exists`);
                } else {
                    stationError.classList.add('d-none');
                    const formData = {
                        station, district, state, address, name, contact, email, type,
                        location: { latitude: parseFloat(latitude), longitude: parseFloat(longitude) },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    try {
                        if (editDocId) {
                            await db.collection('entries').doc(editDocId).set(formData, { merge: true });
                            successes.push('Form data updated successfully!');
                            closeModal();
                        } else {
                            await db.collection('entries').add(formData);
                            successes.push('Form data saved successfully!');
                            closeModal();
                        }
                        formSubmitted = true;
                        await loadTableData();
                    } catch (error) {
                        errors.push(`Form: Error saving data: ${error.message}`);
                    }
                }
            }

            // Process Excel file
            const excelFile = document.getElementById('excelUpload').files[0];
            if (excelFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);

                        // Delete all existing entries
                        try {
                            await deleteAllEntries();
                            successes.push('All existing entries deleted successfully.');
                        } catch (error) {
                            errors.push(`Excel: Error deleting existing entries: ${error.message}`);
                        }

                        const typeMap = {
                            'B': 'Booking',
                            'D': 'Delivery',
                            'B/D': 'Booking & Delivery'
                        };
                        const validTypes = [
                            'Booking', 'Delivery', 'Booking & Delivery',
                            'BOOKING', 'DELIVERY', 'BOOKING AND DELIVERY', 'BOOKING & DELIVERY',
                            'B', 'D', 'B/D'
                        ];

                        for (const row of json) {
                            let latitude = 0;
                            let longitude = 0;
                            const location = String(row.LOCATION || row.location || '');
                            if (location) {
                                const parts = location.split(',');
                                if (parts.length === 2) {
                                    latitude = parseFloat(parts[0].trim()) || 0;
                                    longitude = parseFloat(parts[1].trim()) || 0;
                                } else {
                                    errors.push(`Excel: Invalid LOCATION format in row: ${location}. Must be 'latitude,longitude'`);
                                    continue;
                                }
                            }

                            let typeValue = String(row.TYPE || row.type || '').trim();
                            typeValue = typeMap[typeValue] || typeValue;

                            const formData = {
                                station: String(row.STATION || row.station || '').trim(),
                                district: String(row.DISTRICT || row.district || '').trim(),
                                state: String(row.STATE || row.state || '').trim(),
                                address: String(row.ADDRESS || row.address || '').trim(),
                                name: String(row.NAME || row.name || '').trim(),
                                contact: String(row['CONTACT NO'] || row['contact no'] || row.CONTACT || row.contact || '').trim(),
                                email: String(row['EMAIL ID'] || row['email id'] || row.EMAIL || row.email || '').trim(),
                                type: typeValue,
                                // location: { latitude, longitude },
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            };

                            if (!formData.station || !formData.district || !formData.state) {
                                errors.push(`Excel: Missing or invalid fields in row: ${JSON.stringify(row)}`);
                                continue;
                            }
                            if (!validTypes.includes(formData.type)) {
                                errors.push(`Excel: Invalid type in row: ${formData.type}. Must be one of: Booking, Delivery, Booking & Delivery, BOOKING, DELIVERY, BOOKING AND DELIVERY, B, D, B/D`);
                                continue;
                            }

                            try {
                                await db.collection('entries').add(formData);
                                successes.push(`Excel: Added station "${formData.station}"`);
                            } catch (error) {
                                errors.push(`Excel: Error saving row for station "${formData.station}": ${error.message}`);
                            }
                        }

                        if (errors.length > 0) {
                            uploadStatus.textContent = `Submission completed with errors:\n${errors.join('\n')}`;
                        } else if (successes.length > 0) {
                            uploadStatus.textContent = `Submission successful:\n${successes.join('\n')}`;
                            closeModal();
                        } else {
                            uploadStatus.textContent = 'No valid data submitted from Excel file.';
                        }
                        await loadTableData();
                        document.getElementById('excelUpload').value = '';
                    } catch (error) {
                        uploadStatus.textContent = `Excel: Error processing file: ${error.message}`;
                    }
                };
                reader.readAsArrayBuffer(excelFile);
            } else if (!formSubmitted) {
                // Show error only if neither form nor Excel was submitted
                uploadStatus.textContent = 'No data submitted. Please fill the form or select an Excel file.';
            } else {
                // Form was submitted successfully, show successes/errors
                uploadStatus.textContent = errors.length > 0 
                    ? `Submission completed with errors:\n${errors.join('\n')}`
                    : `Submission successful:\n${successes.join('\n')}`;
            }
        });

        // Download table as Excel
        document.getElementById('downloadExcel').addEventListener('click', async function() {
            const data = await loadTableData();
            const worksheet = XLSX.utils.json_to_sheet(data.map(row => ({
                STATION: row.station,
                DISTRICT: row.district,
                STATE: row.state,
                ADDRESS: row.address,
                NAME: row.name,
                'CONTACT NO': row.contact,
                'EMAIL ID': row.email,
                TYPE: row.type || 'N/A',
                LOCATION: `${row.location.latitude},${row.location.longitude}`
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Entries');
            XLSX.writeFile(workbook, 'entries.xlsx');
        });

        // Initial table load
        loadTableData();
    </script>
</body>
</html>
