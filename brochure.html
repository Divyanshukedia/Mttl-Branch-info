<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Max Transtech Limited - PDF</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- PDFLib -->
  <script src="https://unpkg.com/pdf-lib@1.17.0/dist/pdf-lib.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    #errorMessage {
      color: red;
      text-align: center;
      margin: 10px;
      font-size: 16px;
    }
    #instruction {
      text-align: center;
      margin: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="errorMessage">Generating PDF, please wait...</div>
  <p id="instruction" style="display: none;">PDF is downloading. You can open it in Chrome, Safari, or a PDF viewer app.</p>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyCNUR1sWFPtIurhQRIuujhhSboRoRJvulQ",
      authDomain: "mttl-brochure.firebaseapp.com",
      projectId: "mttl-brochure",
      storageBucket: "mttl-brochure.firebasestorage.app",
      messagingSenderId: "161005945772",
      appId: "1:161005945772:web:e0112b09967491658e3009",
      measurementId: "G-2692HWWKPW"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const { jsPDF } = window.jspdf;

    async function generateMergedPdf() {
      try {
        console.log('Fetching Firestore entries...');
        const snapshot = await db.collection('entries').get();
        if (snapshot.empty) {
          throw new Error('No entries found in Firestore');
        }
        const entries = snapshot.docs.map(doc => doc.data());
        console.log(`Fetched ${entries.length} entries`);

        const mergedPdf = await PDFLib.PDFDocument.create();

        console.log('Fetching front_page_brochure.pdf...');
        const front_page_brochureBytes = await fetch('./front_page_brochure.pdf').then(res => {
          if (!res.ok) throw new Error(`Failed to fetch front_page_brochure.pdf: ${res.statusText}`);
          return res.arrayBuffer();
        });
        const front_page_brochureDoc = await PDFLib.PDFDocument.load(front_page_brochureBytes);
        const front_page_brochurePages = await mergedPdf.copyPages(front_page_brochureDoc, front_page_brochureDoc.getPageIndices());
        front_page_brochurePages.forEach(p => mergedPdf.addPage(p));
        console.log('front_page_brochure.pdf added');

        const doc = new jsPDF({
          unit: 'mm',
          format: [216, 297],
        });

        const entriesByState = {};
        entries.forEach(entry => {
          if (!entriesByState[entry.state]) entriesByState[entry.state] = [];
          entriesByState[entry.state].push(entry);
        });

        let currentY = 30;
        let first = true;

        const sortedStates = Object.keys(entriesByState).sort();

        for (const state of sortedStates) {
          const sortedEntries = entriesByState[state].sort((a, b) => 
            a.station.localeCompare(b.station)
          );
          const rows = sortedEntries.map(e => [e.station, e.address, e.name, e.contact, e.type]);

          if (!first && currentY + 50 > 270) {
            doc.addPage();
            currentY = 30;
          }

          doc.setFontSize(16);
          doc.setFillColor(255, 193, 7);
          doc.rect(10, currentY - 8, 190, 12, 'F');
          doc.setTextColor(0);
          doc.setFont("helvetica", "bold");
          doc.text(`${state.toUpperCase()}: BOOKING AND DELIVERY OFFICES`, 105, currentY, { align: 'center' });
          doc.setFont("helvetica", "normal");

          doc.autoTable({
            startY: currentY + 15,
            head: [['STATION', 'ADDRESS', 'NAME', 'CONTACT NO', 'FACILITY TYPE']],
            body: rows,
            margin: { left: 10, right: 10 },
            styles: {
              fontSize: 8, cellPadding: 2, lineColor: [255, 193, 7], lineWidth: 0.3, halign: 'center'
            },
            headStyles: {
              fillColor: [30, 58, 138], textColor: [255, 255, 255], fontStyle: 'bold',
              lineColor: [255, 193, 7], lineWidth: 0.3, halign: 'center'
            },
            bodyStyles: {
              fillColor: [255, 255, 255], textColor: [0, 0, 0], lineColor: [255, 193, 7],
              lineWidth: 0.3, halign: 'center'
            },
            didDrawPage: (data) => {
              currentY = data.cursor.y;
            }
          });

          currentY += 20;
          first = false;
        }

        const tableBytes = doc.output('arraybuffer');
        const tableDoc = await PDFLib.PDFDocument.load(tableBytes);
        const tablePages = await mergedPdf.copyPages(tableDoc, tableDoc.getPageIndices());
        tablePages.forEach(p => mergedPdf.addPage(p));
        console.log('Table pages added');

        console.log('Fetching last_page_brochure.pdf...');
        const last_page_brochureBytes = await fetch('./last_page_brochure.pdf').then(res => {
          if (!res.ok) throw new Error(`Failed to fetch last_page_brochure.pdf: ${res.statusText}`);
          return res.arrayBuffer();
        });
        const last_page_brochureDoc = await PDFLib.PDFDocument.load(last_page_brochureBytes);
        const last_page_brochurePages = await mergedPdf.copyPages(last_page_brochureDoc, last_page_brochureDoc.getPageIndices());
        last_page_brochurePages.forEach(p => mergedPdf.addPage(p));
        console.log('last_page_brochure.pdf added');

        const finalPdf = await mergedPdf.save();
        console.log('PDF generated successfully');
        return finalPdf;
      } catch (error) {
        console.error('Generate PDF error:', error);
        throw new Error(`Error generating PDF: ${error.message}`);
      }
    }

    async function init() {
      const errorMessage = document.getElementById('errorMessage');
      const instruction = document.getElementById('instruction');

      try {
        console.log('Starting PDF generation...');
        const mergedPdfBytes = await generateMergedPdf();
        const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        console.log('Blob URL created:', url);

        // Trigger automatic download
        const link = document.createElement('a');
        link.href = url;
        link.download = `MaxTranstech_Offices_${new Date().toISOString().slice(0,10)}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        console.log('Download triggered');

        // Show instruction
        errorMessage.textContent = '';
        instruction.style.display = 'block';
      } catch (error) {
        console.error('Init error:', error);
        errorMessage.textContent = `Error loading PDF: ${error.message}`;
      }
    }

    init();
  </script>
</body>
</html>