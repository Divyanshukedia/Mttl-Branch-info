<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Max Transtech Limited - PDF</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- PDFLib -->
  <script src="https://unpkg.com/pdf-lib@1.17.0/dist/pdf-lib.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #f0f0f0;
    }
    #pdfViewer {
      width: 100%;
      height: 100vh;
      border: none;
      display: block;
    }
    #downloadButton {
      display: none;
      padding: 12px 24px;
      background-color: #16a34a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
      text-align: center;
    }
    #downloadButton:hover {
      background-color: #15803d;
    }
    #errorMessage {
      color: red;
      text-align: center;
      margin: 10px;
      font-size: 16px;
    }
    @media only screen and (max-width: 768px) {
      #pdfViewer {
        display: none;
      }
      #downloadButton {
        display: block;
      }
    }
  </style>
</head>
<body>
  <iframe id="pdfViewer"></iframe>
  <button id="downloadButton">Download PDF</button>
  <div id="errorMessage"></div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyCKeLk5NX9bvBVhJfZhkZUATZQyrFNZDqU",
      authDomain: "branch-information-335f6.firebaseapp.com",
      projectId: "branch-information-335f6",
      storageBucket: "branch-information-335f6.firebasestorage.app",
      messagingSenderId: "1017170305224",
      appId: "1:1017170305224:web:d8d84468e8d61d71ea45fd",
      measurementId: "G-X6KYFQJ38Y"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const { jsPDF } = window.jspdf;

    async function generateMergedPdf() {
      try {
        const snapshot = await db.collection('entries').get();
        const entries = snapshot.docs.map(doc => doc.data());

        const mergedPdf = await PDFLib.PDFDocument.create();

        const pdf1Bytes = await fetch('./pdf1.pdf').then(res => {
          if (!res.ok) throw new Error(`Failed to fetch pdf1.pdf: ${res.statusText}`);
          return res.arrayBuffer();
        });
        const pdf1Doc = await PDFLib.PDFDocument.load(pdf1Bytes);
        const pdf1Pages = await mergedPdf.copyPages(pdf1Doc, pdf1Doc.getPageIndices());
        pdf1Pages.forEach(p => mergedPdf.addPage(p));

        const doc = new jsPDF({
          unit: 'mm',
          format: [216, 297],
        });

        const entriesByState = {};
        entries.forEach(entry => {
          if (!entriesByState[entry.state]) entriesByState[entry.state] = [];
          entriesByState[entry.state].push(entry);
        });

        let currentY = 30;
        let first = true;

        for (const state in entriesByState) {
          const rows = entriesByState[state].map(e => [e.station, e.address, e.name, e.contact, e.type]);

          if (!first && currentY + 50 > 270) {
            doc.addPage();
            currentY = 30;
          }

          doc.setFontSize(16);
          doc.setFillColor(255, 193, 7);
          doc.rect(10, currentY - 8, 190, 12, 'F');
          doc.setTextColor(0);
          doc.setFont("helvetica", "bold");
          doc.text(`${state.toUpperCase()}: BOOKING AND DELIVERY OFFICES`, 105, currentY, { align: 'center' });
          doc.setFont("helvetica", "normal");

          doc.autoTable({
            startY: currentY + 15, // Increased padding between header and table
            head: [['STATION', 'ADDRESS', 'NAME', 'CONTACT NO', 'FACILITY TYPE']],
            body: rows,
            margin: { left: 10, right: 10 },
            styles: {
              fontSize: 8, cellPadding: 2, lineColor: [255, 193, 7], lineWidth: 0.3, halign: 'center'
            },
            headStyles: {
              fillColor: [30, 58, 138], textColor: [255, 255, 255], fontStyle: 'bold',
              lineColor: [255, 193, 7], lineWidth: 0.3, halign: 'center'
            },
            bodyStyles: {
              fillColor: [255, 255, 255], textColor: [0, 0, 0], lineColor: [255, 193, 7],
              lineWidth: 0.3, halign: 'center'
            },
            didDrawPage: (data) => {
              currentY = data.cursor.y;
            }
          });

          currentY += 20; // Spacing after the table (from previous request)
          first = false;
        }

        const tableBytes = doc.output('arraybuffer');
        const tableDoc = await PDFLib.PDFDocument.load(tableBytes);
        const tablePages = await mergedPdf.copyPages(tableDoc, tableDoc.getPageIndices());
        tablePages.forEach(p => mergedPdf.addPage(p));

        const pdf2Bytes = await fetch('./pdf2.pdf').then(res => {
          if (!res.ok) throw new Error(`Failed to fetch pdf2.pdf: ${res.statusText}`);
          return res.arrayBuffer();
        });
        const pdf2Doc = await PDFLib.PDFDocument.load(pdf2Bytes);
        const pdf2Pages = await mergedPdf.copyPages(pdf2Doc, pdf2Doc.getPageIndices());
        pdf2Pages.forEach(p => mergedPdf.addPage(p));

        return await mergedPdf.save();
      } catch (error) {
        throw new Error(`Error generating PDF: ${error.message}`);
      }
    }

    async function downloadPdf(pdfBytes) {
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `MaxTranstech_Offices_${new Date().toISOString().slice(0,10)}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    async function init() {
      const errorMessage = document.getElementById('errorMessage');
      try {
        const mergedPdfBytes = await generateMergedPdf();
        const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        const pdfViewer = document.getElementById('pdfViewer');
        pdfViewer.src = url;

        document.getElementById('downloadButton').addEventListener('click', () => downloadPdf(mergedPdfBytes));

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobile) {
          downloadPdf(mergedPdfBytes);
        }
      } catch (error) {
        console.error('Error:', error);
        errorMessage.textContent = `Error loading PDF: ${error.message}. Please use the download button.`;
        document.getElementById('downloadButton').style.display = 'block';
      }
    }

    init();
  </script>
</body>
</html>