<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Max Transtech Data Entry Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <!-- Heroicons (for edit/delete icons) -->
    <script src="https://unpkg.com/@heroicons/vue@2.1.5/dist/outline.js"></script>
    <style>
        .error {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .action-icons svg {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        #authContainer, #selectionContainer, #dashboardContainer {
            display: none;
        }
        .btn-primary {
            background-color: #299ebf;
            border-color: #299ebf;
        }
        .btn-primary:hover {
            background-color: #2386a0;
            border-color: #2386a0;
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div class="container py-4" id="authContainer">
        <h1 class="h3 fw-bold text-center mb-4">Max Transtech - Login</h1>
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <form id="authForm">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" id="email" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" id="password" class="form-control" required>
                            </div>
                            <div id="authError" class="error d-none"></div>
                            <button type="submit" class="btn btn-primary w-100">Sign In</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selection Screen -->
    <div class="container py-4" id="selectionContainer">
        <h1 class="h3 fw-bold text-center mb-4">Select Dashboard</h1>
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <button id="eximButton" class="btn btn-primary w-100 mb-3">Exim</button>
                        <button id="retailButton" class="btn btn-primary w-100">Retail</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div class="container py-4" id="dashboardContainer">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 fw-bold" id="dashboardTitle">Data Entry Dashboard</h1>
            <div>
                <span id="userEmail" class="me-3"></span>
                <button id="switchDashboardButton" class="btn btn-primary me-2">Switch Dashboard</button>
                <button id="signOutButton" class="btn btn-danger me-2">Sign Out</button>
                <button id="addEntryButton" class="btn btn-primary">Add Entry</button>
            </div>
        </div>

        <!-- Modal for Add/Edit Form -->
        <div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Add New Entry</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="dataForm">
                            <input type="hidden" id="editDocId" name="editDocId">
                            <div id="formFields"></div>
                            <div class="col-12">
                                <hr class="my-4">
                                <p class="text-center text-muted mb-3">OR</p>
                                <label for="excelUpload" class="form-label">Upload Excel File</label>
                                <input type="file" id="excelUpload" accept=".xlsx, .xls" class="form-control">
                                <p id="uploadStatus" class="mt-2 text-muted"></p>
                            </div>
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" id="submitButton" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 fw-bold">Existing Entries</h2>
                    <button id="downloadExcel" class="btn btn-success">Download as Excel</button>
                </div>
                <table id="dataTable" class="table table-striped">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCNUR1sWFPtIurhQRIuujhhSboRoRJvulQ",
            authDomain: "mttl-brochure.firebaseapp.com",
            projectId: "mttl-brochure",
            storageBucket: "mttl-brochure.firebasestorage.app",
            messagingSenderId: "161005945772",
            appId: "1:161005945772:web:e0112b09967491658e3009",
            measurementId: "G-2692HWWKPW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const selectionContainer = document.getElementById('selectionContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const authForm = document.getElementById('authForm');
        const authError = document.getElementById('authError');
        const userEmail = document.getElementById('userEmail');
        const signOutButton = document.getElementById('signOutButton');
        const switchDashboardButton = document.getElementById('switchDashboardButton');
        const eximButton = document.getElementById('eximButton');
        const retailButton = document.getElementById('retailButton');
        const dashboardTitle = document.getElementById('dashboardTitle');
        const addEntryButton = document.getElementById('addEntryButton');
        const modal = new bootstrap.Modal(document.getElementById('dataModal'));
        const modalTitle = document.getElementById('modalTitle');
        const submitButton = document.getElementById('submitButton');
        const formFields = document.getElementById('formFields');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const downloadExcel = document.getElementById('downloadExcel');

        let currentCollection = null;

        // Authentication State Handler
        auth.onAuthStateChanged(user => {
            if (user) {
                authContainer.style.display = 'none';
                selectionContainer.style.display = 'block';
                dashboardContainer.style.display = 'none';
                userEmail.textContent = `Signed in as: ${user.email}`;
            } else {
                authContainer.style.display = 'block';
                selectionContainer.style.display = 'none';
                dashboardContainer.style.display = 'none';
                userEmail.textContent = '';
            }
        });

        // Sign In Handler
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            authError.classList.add('d-none');

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                authError.textContent = `Error: ${error.message}`;
                authError.classList.remove('d-none');
            }
        });

        // Sign Out Handler
        signOutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                alert('Signed out successfully!');
            } catch (error) {
                alert('Error signing out: ' + error.message);
            }
        });

        // Switch Dashboard Handler
        switchDashboardButton.addEventListener('click', () => {
            dashboardContainer.style.display = 'none';
            selectionContainer.style.display = 'block';
            currentCollection = null;
            if ($.fn.DataTable.isDataTable('#dataTable')) {
                $('#dataTable').DataTable().destroy();
            }
            tableBody.innerHTML = '';
            tableHead.innerHTML = '';
        });

        // Dashboard Selection Handlers
        eximButton.addEventListener('click', () => {
            currentCollection = 'exim';
            dashboardTitle.textContent = 'Eximod Data Entry Dashboard';
            selectionContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
            setupDashboard('exim');
        });

        retailButton.addEventListener('click', () => {
            currentCollection = 'entries';
            dashboardTitle.textContent = 'Retail Data Entry Dashboard';
            selectionContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
            setupDashboard('entries');
        });

        // Modal control
        function openModal(mode = 'add', data = null) {
            if (mode === 'edit' && data) {
                modalTitle.textContent = 'Edit Entry';
                submitButton.textContent = 'Update';
                submitButton.classList.remove('btn-primary');
                submitButton.classList.add('btn-success');
                document.getElementById('editDocId').value = data.docId;
                populateFormFields(data);
            } else {
                modalTitle.textContent = 'Add New Entry';
                document.getElementById('dataForm').reset();
                document.getElementById('editDocId').value = '';
                submitButton.textContent = 'Submit';
                submitButton.classList.remove('btn-success');
                submitButton.classList.add('btn-primary');
                document.getElementById('locationError')?.classList.add('d-none');
                document.getElementById('stationError')?.classList.add('d-none');
            }
            modal.show();
        }

        function closeModal() {
            modal.hide();
            document.getElementById('dataForm').reset();
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('locationError')?.classList.add('d-none');
            document.getElementById('stationError')?.classList.add('d-none');
        }

        addEntryButton.addEventListener('click', () => openModal('add'));

        // Setup Dashboard
        function setupDashboard(collection) {
            formFields.innerHTML = collection === 'exim' ? `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="location" class="form-label">LOCATION</label>
                        <input type="text" id="location" name="location" class="form-control">
                        <p id="locationError" class="error d-none">Location already exists</p>
                    </div>
                    <div class="col-md-6">
                        <label for="name" class="form-label">NAME</label>
                        <input type="text" id="name" name="name" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="address" class="form-label">ADDRESS</label>
                        <input type="text" id="address" name="address" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="phone" class="form-label">PHONE NUMBER</label>
                        <input type="tel" id="phone" name="phone" class="form-control">
                    </div>
                </div>
            ` : `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="station" class="form-label">STATION</label>
                        <input type="text" id="station" name="station" class="form-control">
                        <p id="stationError" class="error d-none">Station already exists</p>
                    </div>
                    <div class="col-md-6">
                        <label for="district" class="form-label">DISTRICT</label>
                        <input type="text" id="district" name="district" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="state" class="form-label">STATE</label>
                        <input type="text" id="state" name="state" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="address" class="form-label">ADDRESS</label>
                        <input type="text" id="address" name="address" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="name" class="form-label">NAME</label>
                        <input type="text" id="name" name="name" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="contact" class="form-label">CONTACT NO</label>
                        <input type="tel" id="contact" name="contact" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">EMAIL ID</label>
                        <input type="email" id="email" name="email" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="type" class="form-label">TYPE</label>
                        <select id="type" name="type" class="form-select">
                            <option value="" disabled selected>Select Type</option>
                            <option value="Booking">Booking</option>
                            <option value="Delivery">Delivery</option>
                            <option value="Booking & Delivery">Booking & Delivery</option>
                        </select>
                    </div>
                </div>
            `;

            tableHead.innerHTML = collection === 'exim' ? `
                <tr>
                    <th>LOCATION</th>
                    <th>NAME</th>
                    <th>ADDRESS</th>
                    <th>PHONE NUMBER</th>
                    <th>ACTION</th>
                </tr>
            ` : `
                <tr>
                    <th>STATION</th>
                    <th>DISTRICT</th>
                    <th>STATE</th>
                    <th>ADDRESS</th>
                    <th>NAME</th>
                    <th>CONTACT NO</th>
                    <th>EMAIL ID</th>
                    <th>TYPE</th>
                    <th>ACTION</th>
                </tr>
            `;

            loadTableData(collection);
        }

        // Populate Form Fields for Edit
        function populateFormFields(data) {
            if (currentCollection === 'exim') {
                document.getElementById('location').value = data.location || '';
                document.getElementById('name').value = data.name || '';
                document.getElementById('address').value = data.address || '';
                document.getElementById('phone').value = data.phone || '';
            } else {
                document.getElementById('station').value = data.station || '';
                document.getElementById('district').value = data.district || '';
                document.getElementById('state').value = data.state || '';
                document.getElementById('address').value = data.address || '';
                document.getElementById('name').value = data.name || '';
                document.getElementById('contact').value = data.contact || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('type').value = data.type || '';
            }
        }

        // Check for Duplicates
        async function getDuplicateDocId(collection, keyField, keyValue, secondaryField = null, secondaryValue = null) {
            if (!keyField || !keyValue) return null;
            try {
                const snapshot = await db.collection(collection).get();
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    if (secondaryField && secondaryValue) {
                        if (data[keyField]?.toLowerCase() === keyValue.toLowerCase() &&
                            data[secondaryField]?.toLowerCase() === secondaryValue.toLowerCase()) {
                            return doc.id;
                        }
                    } else {
                        if (data[keyField]?.toLowerCase() === keyValue.toLowerCase()) {
                            return doc.id;
                        }
                    }
                }
                return null;
            } catch (error) {
                console.error(`Error checking duplicate in ${collection}:`, error);
                return null;
            }
        }

        // Load Table Data
        async function loadTableData(collection) {
            tableBody.innerHTML = '';
            try {
                const snapshot = await db.collection(collection).get();
                const data = [];
                snapshot.forEach(doc => {
                    const entry = doc.data();
                    const docId = doc.id;
                    data.push({ ...entry, docId });
                    const row = document.createElement('tr');
                    row.innerHTML = collection === 'exim' ? `
                        <td>${entry.location || ''}</td>
                        <td>${entry.name || ''}</td>
                        <td>${entry.address || ''}</td>
                        <td>${entry.phone || ''}</td>
                        <td class="action-icons">
                            <span class="text-primary me-2" data-id="${docId}" data-action="edit">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </span>
                            <span class="text-danger" data-id="${docId}" data-action="delete">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </span>
                        </td>
                    ` : `
                        <td>${entry.station || ''}</td>
                        <td>${entry.district || ''}</td>
                        <td>${entry.state || ''}</td>
                        <td>${entry.address || ''}</td>
                        <td>${entry.name || ''}</td>
                        <td>${entry.contact || ''}</td>
                        <td>${entry.email || ''}</td>
                        <td>${entry.type || 'N/A'}</td>
                        <td class="action-icons">
                            <span class="text-primary me-2" data-id="${docId}" data-action="edit">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </span>
                            <span class="text-danger" data-id="${docId}" data-action="delete">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </span>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Initialize DataTables
                if ($.fn.DataTable.isDataTable('#dataTable')) {
                    $('#dataTable').DataTable().destroy();
                }
                $('#dataTable').DataTable({
                    pageLength: 10,
                    searching: true,
                    ordering: true,
                    lengthMenu: [5, 10, 25, 50],
                    columnDefs: [{ orderable: false, targets: -1 }],
                    language: { search: "Search entries:", lengthMenu: "Show _MENU_ entries" }
                });

                // Attach Edit/Delete Listeners
                document.querySelectorAll('[data-action="edit"]').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.closest('[data-id]').dataset.id;
                        try {
                            const doc = await db.collection(collection).doc(docId).get();
                            const data = { ...doc.data(), docId };
                            openModal('edit', data);
                        } catch (error) {
                            alert('Error loading entry: ' + error.message);
                        }
                    });
                });

                document.querySelectorAll('[data-action="delete"]').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.closest('[data-id]').dataset.id;
                        if (confirm('Are you sure you want to delete this entry?')) {
                            try {
                                await db.collection(collection).doc(docId).delete();
                                await loadTableData(collection);
                                alert('Entry deleted successfully!');
                            } catch (error) {
                                alert('Error deleting entry: ' + error.message);
                            }
                        }
                    });
                });

                return data;
            } catch (error) {
                alert('Error loading data: ' + error.message);
            }
        }

        // Form and Excel Submission
        document.getElementById('dataForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.textContent = 'Processing...';
            let errors = [];
            let successes = [];
            let formSubmitted = false;

            // Process Form Data
            if (currentCollection === 'exim') {
                const editDocId = document.getElementById('editDocId').value;
                const location = document.getElementById('location').value.trim();
                const name = document.getElementById('name').value.trim();
                const address = document.getElementById('address').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const locationError = document.getElementById('locationError');

                if (location && name) {
                    const existingDocId = await getDuplicateDocId('exim', 'location', location, 'name', name);
                    if (existingDocId && existingDocId !== editDocId) {
                        locationError.classList.remove('d-none');
                        errors.push(`Form: Location "${location}" and Name "${name}" already exist`);
                    } else {
                        locationError.classList.add('d-none');
                        const formData = {
                            location, name, address, phone,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        try {
                            if (editDocId) {
                                await db.collection('exim').doc(editDocId).set(formData, { merge: true });
                                successes.push('Form data updated successfully!');
                                closeModal();
                            } else {
                                await db.collection('exim').add(formData);
                                successes.push('Form data saved successfully!');
                                closeModal();
                            }
                            formSubmitted = true;
                            await loadTableData('exim');
                        } catch (error) {
                            errors.push(`Form: Error saving data: ${error.message}`);
                        }
                    }
                }
            } else {
                const editDocId = document.getElementById('editDocId').value;
                const station = document.getElementById('station').value.trim();
                const district = document.getElementById('district').value.trim();
                const state = document.getElementById('state').value.trim();
                const address = document.getElementById('address').value.trim();
                const name = document.getElementById('name').value.trim();
                const contact = document.getElementById('contact').value.trim();
                const email = document.getElementById('email').value.trim();
                const type = document.getElementById('type').value;
                const stationError = document.getElementById('stationError');

                if (station && district && state) {
                    const existingDocId = await getDuplicateDocId('entries', 'station', station);
                    if (existingDocId && existingDocId !== editDocId) {
                        stationError.classList.remove('d-none');
                        errors.push(`Form: Station "${station}" already exists`);
                    } else {
                        stationError.classList.add('d-none');
                        const formData = {
                            station, district, state, address, name, contact, email, type,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        try {
                            if (editDocId) {
                                await db.collection('entries').doc(editDocId).set(formData, { merge: true });
                                successes.push('Form data updated successfully!');
                                closeModal();
                            } else {
                                await db.collection('entries').add(formData);
                                successes.push('Form data saved successfully!');
                                closeModal();
                            }
                            formSubmitted = true;
                            await loadTableData('entries');
                        } catch (error) {
                            errors.push(`Form: Error saving data: ${error.message}`);
                        }
                    }
                }
            }

            // Process Excel File
            const excelFile = document.getElementById('excelUpload').files[0];
            if (excelFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);

                        if (currentCollection === 'exim') {
                            for (const row of json) {
                                const formData = {
                                    location: String(row.LOCATION || row.location || '').trim(),
                                    name: String(row.NAME || row.name || '').trim(),
                                    address: String(row.ADDRESS || row.address || '').trim(),
                                    phone: String(row['PHONE NUMBER'] || row['phone number'] || row.PHONE || row.phone || '').trim(),
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                };

                                if (!formData.location || !formData.name) {
                                    errors.push(`Excel: Missing or invalid fields in row: ${JSON.stringify(row)}`);
                                    continue;
                                }

                                const existingDocId = await getDuplicateDocId('exim', 'location', formData.location, 'name', formData.name);
                                if (existingDocId) {
                                    errors.push(`Excel: Location "${formData.location}" and Name "${formData.name}" already exist`);
                                    continue;
                                }

                                try {
                                    await db.collection('exim').add(formData);
                                    successes.push(`Excel: Added location "${formData.location}"`);
                                } catch (error) {
                                    errors.push(`Excel: Error saving row for location "${formData.location}": ${error.message}`);
                                }
                            }
                        } else {
                            const typeMap = {
                                'B': 'Booking',
                                'D': 'Delivery',
                                'B/D': 'Booking & Delivery',
                                'Booking': 'Booking',
                                'Delivery': 'Delivery',
                                'Booking & Delivery': 'Booking & Delivery',
                                'Booking/Delivery': 'Booking & Delivery',
                                'Transshipment Hub': 'Transshipment Hub'
                            };
                            const validTypes = [
                                'Booking', 'Delivery', 'Booking & Delivery',
                                'BOOKING', 'DELIVERY', 'BOOKING AND DELIVERY', 'BOOKING & DELIVERY',
                                'B', 'D', 'B/D', 'Booking/Delivery', 'Transshipment Hub'
                            ];

                            for (const row of json) {
                                let typeValue = String(row.TYPE || row.type || '').trim();
                                typeValue = typeMap[typeValue] || typeValue;

                                const formData = {
                                    station: String(row.STATION || row.station || '').trim(),
                                    district: String(row.DISTRICT || row.district || '').trim(),
                                    state: String(row.STATE || row.state || '').trim(),
                                    address: String(row.ADDRESS || row.address || '').trim(),
                                    name: String(row.NAME || row.name || '').trim(),
                                    contact: String(row['CONTACT NO'] || row['contact no'] || row.CONTACT || row.contact || '').trim(),
                                    email: String(row['EMAIL ID'] || row['email id'] || row.EMAIL || row.email || '').trim(),
                                    type: typeValue,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                };

                                if (!formData.station || !formData.district || !formData.state) {
                                    errors.push(`Excel: Missing or invalid fields in row: ${JSON.stringify(row)}`);
                                    continue;
                                }
                                if (!validTypes.includes(formData.type)) {
                                    errors.push(`Excel: Invalid type in row: ${formData.type}. Must be one of: Booking, Delivery, Booking & Delivery, B, D, B/D`);
                                    continue;
                                }

                                const existingDocId = await getDuplicateDocId('entries', 'station', formData.station);
                                if (existingDocId) {
                                    errors.push(`Excel: Station "${formData.station}" already exists`);
                                    continue;
                                }

                                try {
                                    await db.collection('entries').add(formData);
                                    successes.push(`Excel: Added station "${formData.station}"`);
                                } catch (error) {
                                    errors.push(`Excel: Error saving row for station "${formData.station}": ${error.message}`);
                                }
                            }
                        }

                        if (errors.length > 0) {
                            uploadStatus.textContent = `Submission completed with errors:\n${errors.join('\n')}`;
                        } else if (successes.length > 0) {
                            uploadStatus.textContent = `Submission successful:\n${successes.join('\n')}`;
                            closeModal();
                        } else {
                            uploadStatus.textContent = 'No valid data submitted from Excel file.';
                        }
                        await loadTableData(currentCollection);
                        document.getElementById('excelUpload').value = '';
                    } catch (error) {
                        uploadStatus.textContent = `Excel: Error processing file: ${error.message}`;
                    }
                };
                reader.readAsArrayBuffer(excelFile);
            } else if (!formSubmitted) {
                uploadStatus.textContent = 'No data submitted. Please fill the form or select an Excel file.';
            } else {
                uploadStatus.textContent = errors.length > 0 
                    ? `Submission completed with errors:\n${errors.join('\n')}`
                    : `Submission successful:\n${successes.join('\n')}`;
            }
        });

        // Download Table as Excel
        downloadExcel.addEventListener('click', async function() {
            try {
                const data = await loadTableData(currentCollection);
                if (currentCollection === 'exim') {
                    const worksheet = XLSX.utils.json_to_sheet(data.map(row => ({
                        LOCATION: row.location,
                        NAME: row.name,
                        ADDRESS: row.address,
                        'PHONE NUMBER': row.phone
                    })));
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Exim Entries');
                    XLSX.writeFile(workbook, 'exim_entries.xlsx');
                } else {
                    const worksheet = XLSX.utils.json_to_sheet(data.map(row => ({
                        STATION: row.station,
                        DISTRICT: row.district,
                        STATE: row.state,
                        ADDRESS: row.address,
                        NAME: row.name,
                        'CONTACT NO': row.contact,
                        'EMAIL ID': row.email,
                        TYPE: row.type || 'N/A'
                    })));
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Retail Entries');
                    XLSX.writeFile(workbook, 'retail_entries.xlsx');
                }
            } catch (error) {
                alert('Error downloading Excel: ' + error.message);
            }
        });
    </script>
</body>
</html>
